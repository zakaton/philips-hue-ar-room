<html>
  <head>
    <title>Philips Hue AR Room</title>
    <script crossorigin="anonymous" src="src/aframe.min.js"></script>
    <script src="src/components/persistent-anchors-component.js"></script>
    <script src="src/components/camera-controls-component.js"></script>
    <script src="src/PhilipsHue.js"></script>
    <script src="src/components/philips-hue-component.js"></script>
    <script src="src/components/detected-planes-component.js"></script>
    <!-- https://github.com/gftruj/aframe-hand-tracking-controls-extras -->
    <script src="src/components/hand-tracking-controls-extras.js"></script>
  </head>
  <body>
    <a-scene
      light="defaultLightsEnabled: false"
      shadow="type: pcfsoft"
      renderer="colorManagement:true; toneMapping:ACESFilmic;"
      persistent-anchors="target: #sceneContainer; targetAnchor: #internalAnchor;"
      webxr="optionalFeatures: anchors; requiredFeatures: plane-detection,local-floor;"
      detected-planes
    >
      <a-assets>
        <a-asset-item id="roomModel" src="assets/room.glb"></a-asset-item>
        <a-asset-item id="anchorModel" src="assets/anchor.glb"></a-asset-item>
        <a-asset-item
          id="flashlightModel"
          src="assets/flashlight.glb"
        ></a-asset-item>
        <a-asset-item id="torchModel" src="assets/torch.glb"></a-asset-item>
        <a-asset-item id="violinModel" src="assets/violin.glb"></a-asset-item>
      </a-assets>

      <a-entity visible="false" id="anchor">
        <a-box scale="0.01 0.01 0.01" color="red" visible="false"></a-box>
        <a-entity position="0 -0.2 -0.1">
          <a-entity
            gltf-model="#anchorModel"
            scale="0.020 0.020 0.020"
            position="0 0.119 0"
            rotation="0 0 0"
          ></a-entity>
        </a-entity>
      </a-entity>

      <a-camera position="0 1.6 0" id="camera">
        <a-entity id="cameraForward" position="0 0 -10"></a-entity>
      </a-camera>

      <a-entity
        id="leftHandControls"
        oculus-touch-controls="hand: left; model: false;"
        camera-controls="hand: left;"
      ></a-entity>
      <a-entity
        id="rightHandControls"
        oculus-touch-controls="hand: right; model: false;"
        camera-controls="hand: right;"
      >
        <a-box visible="false" color="red" scale="0.01 0.01 0.01"></a-box>
        <a-entity
          id="torch"
          gltf-model="#torchModel"
          visible="false"
          scale="5 5 5"
          rotation="-97.4 0 6"
          position="0.015 0 0.1"
        ></a-entity>
        <a-entity
          id="flashlight"
          gltf-model="#flashlightModel"
          visible="false"
          position="0.03 0.04 0.15"
          scale="0.03 0.03 0.03"
          rotation="-109 0 8.6"
        ></a-entity>
        <a-entity position="0 -0.2 -0.1" id="handAnchor" visible="false">
          <a-entity
            gltf-model="#anchorModel"
            scale="0.020 0.020 0.020"
            position="0 0.119 0"
            rotation="0 0 0"
          ></a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="sceneContainer" position="0 1 -3.219">
        <a-entity
          id="violin"
          gltf-model="#violinModel"
          rotation="0 -90.000 0"
          position="0 -0.060 2.149"
        ></a-entity>

        <a-entity id="internalAnchor" position="0 0 0">
          <a-entity position="0 -0.2 -0.1">
            <a-entity
              gltf-model="#anchorModel"
              scale="0.020 0.020 0.020"
              position="0 0.119 0"
              rotation="0 0 0"
            ></a-entity>
          </a-entity>
        </a-entity>

        <a-entity
          data-toggle-visibility
          data-color-write="false"
          gltf-model="#roomModel"
          position="0 0 0"
          scale="1 1 1"
          shadow="receive: true; cast: false;"
          rotation="0 0 0"
          id="room"
        ></a-entity>

        <a-entity
          philips-hue="bridge: 0; light: 1;"
          id="livingRoomLightBR"
          position="1.135 0.000 2.831"
        ></a-entity>

        <a-entity
          philips-hue="bridge: 0; light: 2;"
          id="livingRoomLightBL"
          position="1.422 0 5.749"
        ></a-entity>

        <a-entity
          philips-hue="bridge: 0; light: 3;"
          id="kitchenLight1"
          position="-0.868 1.673 0.521"
        ></a-entity>
        <a-entity
          philips-hue="bridge: 0; light: 4;"
          id="livingRoomBRA"
          position="1.607 0.778 2.536"
        ></a-entity>
        <a-entity
          philips-hue="bridge: 0; light: 5;"
          id="livingRoomFLA"
          position="-2.195 0.743 6.178"
        ></a-entity>
        <a-entity
          philips-hue="bridge: 0; light: 6;"
          id="kitchenLight4"
          position="0.638 1.673 1.496"
        ></a-entity>
        <a-entity
          philips-hue="bridge: 0; light: 7;"
          id="livingRoomFLB"
          position="-2.195 0.743 6.178"
        ></a-entity>
        <a-entity
          philips-hue="bridge: 0; light: 8;"
          id="kitchenLight3"
          position="1.473 1.673 1.301"
        ></a-entity>
        <a-entity
          philips-hue="bridge: 0; light: 9;"
          id="kitchenLight5"
          position="-0.898 1.673 1.546"
        ></a-entity>
        <a-entity
          philips-hue="bridge: 0; light: 10;"
          id="livingRoomBRB"
          position="1.607 0.778 2.536"
        ></a-entity>
        <a-entity
          philips-hue="bridge: 0; light: 11;"
          id="kitchenLight2"
          position="0.690 1.673 0.511"
        ></a-entity>
        <a-entity
          philips-hue="bridge: 0; light: 12;"
          id="livingRoomFRB"
          position="-1.806 0.148 2.978"
        ></a-entity>
        <a-entity
          philips-hue="bridge: 0; light: 13;"
          id="livingRoomFRA"
          position="-1.858 0.782 2.722"
        ></a-entity>
      </a-entity>
    </a-scene>
  </body>
  <script>
    function setupWebsocketConnection(onMessage, onConnect) {
      // Create WebSocket connection.
      let socket;

      const createSocket = () => {
        socket = window.socket = new WebSocket(`ws://${location.host}/`);

        socket.addEventListener("open", () => {
          console.log("connection opened");
          if (onConnect) {
            onConnect();
          }
        });
        socket.addEventListener("message", (event) => {
          //console.log("Message from server ", event.data);
          const message = JSON.parse(event.data);
          if (onMessage) {
            onMessage(message);
          }
        });
        socket.addEventListener("close", (event) => {
          console.log("connection closed");
          createSocket();
        });
      };
      createSocket();

      const send = (object) => {
        socket.send(JSON.stringify(object));
      };

      return send;
    }
    window.sendMessage = setupWebsocketConnection();
  </script>
</html>
