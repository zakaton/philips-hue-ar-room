<html>
  <head>
    <title>Philips Hue AR (Desktop)</title>
    <script src="/src/socket.io.min.js"></script>
  </head>
  <body>
    <h1>Philips Hue AR (Desktop)</h1>

    <p id="socketConnection"></p>

    <button id="discoverBridges">rediscover bridges</button>

    <div id="bridges">
      <template id="bridgeTemplate">
        <ol class="bridge">
          <li>
            name: <b class="name"></b>
            <ul>
              <li>id: <b class="id"></b></li>
              <li>ip: <b class="ip"></b></li>
              <li>credentials: <b class="credentials"></b></li>
              <button class="getCredentials" hidden>
                get credentials (press bridge button first)
              </button>
              <li>group: <b class="group"></b></li>
              <button class="getGroup" hidden>refresh group</button>
            </ul>
          </li>
        </ol>
      </template>
    </div>
  </body>
  <script>
    const socket = io();
    socket.on("connect", () => {
      console.log("connection opened");
      socketConnectionContainer.innerText = "connected to server";
    });
    socket.on("disconnect", () => {
      console.log("connection closed");
      socketConnectionContainer.innerText = "disconnected from server";
    });

    const socketConnectionContainer =
      document.getElementById("socketConnection");

    const discoverBridgesButton = document.getElementById("discoverBridges");
    discoverBridgesButton.addEventListener("click", () => {
      socket.emit("discoverBridges");
    });

    const bridgeTemplate = document.getElementById("bridgeTemplate");
    const bridgesContainer = document.getElementById("bridges");

    let bridges = [];
    socket.on("bridges", (_bridges) => {
      bridges = _bridges;
      bridgesContainer.innerHTML = "";
      bridges.forEach((bridge) => {
        const bridgeContainer = bridgeTemplate.content
          .cloneNode(true)
          .querySelector(".bridge");
        for (const key in bridge) {
          let value = bridge[key];
          if (typeof value == "object") {
            value = JSON.stringify(value);
          }
          const container = bridgeContainer.querySelector(`.${key}`);
          if (container) {
            container.innerText = value;
          }
        }
        if (!bridge.credentials) {
          const credentialsContainer =
            bridgeContainer.querySelector(`.credentials`);
          credentialsContainer.parentElement.setAttribute("hidden", "");
          const getCredentialsButton =
            bridgeContainer.querySelector(".getCredentials");
          getCredentialsButton.removeAttribute("hidden");
          getCredentialsButton.addEventListener("click", () => {
            socket.emit("getCredentials", bridge.ip, (credentials) => {
              bridge.credentials = credentials;
              if (credentials) {
                credentialsContainer.parentElement.removeAttribute("hidden");
                credentialsContainer.innerText = JSON.stringify(credentials);
                getCredentialsButton.setAttribute("hidden", "");
              }
            });
          });
        }
        if (bridge.group) {
          const groupContainer = document.querySelector(".group");
          const getGroupButton = bridgeContainer.querySelector(".getGroup");
          getGroupButton.removeAttribute("hidden");
          getGroupButton.addEventListener("click", () => {
            socket.emit("getGroup", bridge.ip, (group) => {
              bridge.group = group;
              if (group) {
                groupContainer.parentElement.removeAttribute("hidden");
                groupContainer.innerText = JSON.stringify(credentials);
              }
            });
          });
        }
        bridgesContainer.appendChild(bridgeContainer);
      });
    });
  </script>
</html>
